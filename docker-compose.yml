services:
    # --------------------
    # Databases
    # --------------------
    app-db:
        image: postgres:17
        container_name: app-db
        restart: unless-stopped
        environment:
            POSTGRES_DB: portfolio_app
            POSTGRES_USER: app_user
            POSTGRES_PASSWORD: app_pass
        ports:
            - "5433:5432" # host:container (optional for direct DB access)
        volumes:
            - app_db_data:/var/lib/postgresql/data
        networks:
            - portfolio-net
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U app_user -d portfolio_app"]
            interval: 5s
            timeout: 5s
            retries: 10
            start_period: 10s

    auth-db:
        image: postgres:17
        container_name: auth-db
        restart: unless-stopped
        environment:
            POSTGRES_DB: auth_db
            POSTGRES_USER: auth_user
            POSTGRES_PASSWORD: auth_pass
        ports:
            - "5434:5432" # optional
        volumes:
            - auth_db_data:/var/lib/postgresql/data
        networks:
            - portfolio-net
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U auth_user -d auth_db"]
            interval: 5s
            timeout: 5s
            retries: 10
            start_period: 10s

    # --------------------
    # Backend (Next.js)
    # --------------------
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: backend
        restart: unless-stopped
        env_file:
            - .env
        environment:
            NODE_ENV: development
            
            # Database connection
            DATABASE_URL: postgres://app_user:app_pass@app-db:5432/portfolio_app
            
            # JWT validation (must match auth-service)
            AUTH_JWT_SECRET: ${AUTH_JWT_SECRET}
            AUTH_JWT_ISS: portfolio-auth
            AUTH_JWT_AUD: portfolio-api
            
            # CORS configuration (comma-separated list of allowed origins)
            CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:8080}
            
            # Auth service URL for token validation
            AUTH_SERVICE_URL: http://auth-service:3001
            
            # DigitalOcean Spaces configuration
            DO_SPACES_ENDPOINT: https://nyc3.digitaloceanspaces.com
            DO_SPACES_REGION: nyc3
            DO_SPACES_BUCKET: portfolio-app
            DO_SPACES_ACCESS_KEY_ID: ${DO_SPACES_ACCESS_KEY_ID}
            DO_SPACES_SECRET_ACCESS_KEY: ${DO_SPACES_SECRET_ACCESS_KEY}
            DO_SPACES_CDN_ENDPOINT: https://portfolio-app.nyc3.cdn.digitaloceanspaces.com
            
            # Port configuration
            PORT: 8080
        depends_on:
            app-db:
                condition: service_healthy
            auth-service:
                condition: service_started
        ports:
            - "8080:8080"
        networks:
            - portfolio-net

    # --------------------
    # Auth service (Better Auth, Node/Next)
    # --------------------
    auth-service:
        build:
            context: ./auth-service
            dockerfile: Dockerfile
        container_name: auth-service
        restart: unless-stopped
        env_file:
            - .env
        environment:
            NODE_ENV: development
            
            # DB for auth / Better Auth
            DATABASE_URL: postgres://auth_user:auth_pass@auth-db:5432/auth_db
            POSTGRES_USER: auth_user
            POSTGRES_PASSWORD: auth_pass
            POSTGRES_DB: auth_db

            # Better Auth configuration
            BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
            BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3001}

            # JWT issuing (shared secret + claims)
            BETTER_AUTH_JWT_SECRET: ${AUTH_JWT_SECRET}
            BETTER_AUTH_JWT_ISS: portfolio-auth
            BETTER_AUTH_JWT_AUD: portfolio-api

            # CORS configuration (comma-separated list of allowed origins)
            CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}

            # Google OAuth (optional)
            GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
            GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}

            # Frontend URL for OAuth redirects
            FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
            
            # Port configuration
            PORT: 3001
        depends_on:
            auth-db:
                condition: service_healthy
        ports:
            - "3001:3001"
        networks:
            - portfolio-net

    # --------------------
    # Frontend (Next.js)
    # --------------------
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
            args:
                # Pass public environment variables as build arguments
                # NEXT_PUBLIC_* variables must be available at build time for Next.js
                NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
                NEXT_PUBLIC_AUTH_SERVICE_URL: ${NEXT_PUBLIC_AUTH_SERVICE_URL:-http://localhost:3001}
        container_name: frontend
        restart: unless-stopped
        env_file:
            - .env
        environment:
            NODE_ENV: development
            
            # Client-side (browser) uses localhost to access host machine
            NEXT_PUBLIC_API_URL: http://localhost:8080
            NEXT_PUBLIC_AUTH_SERVICE_URL: http://localhost:3001
            
            # Server-side (SSR) uses service names for container-to-container communication
            API_URL: http://backend:8080
            AUTH_SERVICE_URL: http://auth-service:3001
            
            # Port configuration
            PORT: 3000
        depends_on:
            - backend
            - auth-service
        ports:
            - "3000:3000"
        networks:
            - portfolio-net

    # --------------------
    # Database Admin (pgAdmin) - Development Only
    # Use profile to start: docker compose --profile pgadmin up -d
    # Requires PGADMIN_DEFAULT_EMAIL and PGADMIN_DEFAULT_PASSWORD in .env file
    # --------------------
    pgadmin:
        profiles: ["pgadmin"]
        image: dpage/pgadmin4:8.8
        container_name: pgadmin
        restart: unless-stopped
        env_file:
            - .env
        environment:
            PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@portfolio.com}
            PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin123}
            PGADMIN_CONFIG_SERVER_MODE: "False"
        ports:
            - "5050:80"
        volumes:
            - pgadmin_data:/var/lib/pgadmin
        networks:
            - portfolio-net
        depends_on:
            - app-db
            - auth-db

networks:
    portfolio-net:

volumes:
    app_db_data:
    auth_db_data:
    pgadmin_data:
